<!DOCTYPE html><html><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 从浏览器地址栏输入一串url到页面呈现这个过程中发生了什么？ · hammer's blog</title><meta name="description" content="从浏览器地址栏输入一串url到页面呈现这个过程中发生了什么？ - hammer"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="hammer's blog"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">从浏览器地址栏输入一串url到页面呈现这个过程中发生了什么？</h1><div class="post-info">Dec 23, 2017</div><div class="post-content"><p>##线索</p>
<p>从浏览器地址栏输入一串url到页面呈现这个过程中发生了什么？在很多场合看见过这个问题，但一般也就大概浏览一下，自己并没有去深入研究一番，最近有空便研究了下，网上当然也有很多类似的分析，而且有些甚至涉及到物理层的底层硬件相关，虽然自己本科专业是电子信息专业，但只是懂个轮廓，很多细节还是不太清楚，所以自己的笔记目前就只囊括在非物理层的描述。</p>
<p>##URL</p>
<p>URL(universal resource locator)的中文译名是统一资源定位符，可以理解为一个用于标识资源地址的符号,它的发明者即被称为“互联网之父”的Tim Berners-Lee，最近刚获得2016年的图灵奖。一个标准的url由协议名，服务器，端口号，文件路径，查询字符组成:<br>protocol :// hostname[:port] / path / parameters?query#fragment<br>在大多数浏览器中，我们可以省略协议名或者端口号，因为几乎所有网页内容都是基于http或https的，然后端口也是默认的80。<br>比如我博客的url是：<br>“h ttp://ahammer.science/2017/03/19/%E5%89%8D%E7%AB%AF%E5%B7%A5%E7%A8%8B%E5%8C%96-%E5%88%9D%E8%AF%86/“<br>这里面省略了端口号与查询字符，至于末尾一连串的%开头的字符则是因为浏览器不能直接识别含有中文的文件路径而做的编码处理。<br>当我们在浏览器地址栏中输入的url不规范时，比如直接是中文，或者协议名，主机名不规范时，通常浏览器会将该输入传给默认的搜索引擎并返回相应的搜索结果，还有种情况，有些网站我们不输入协议名与www而只输入部分字符现代浏览器都会自动补全可能的完整的网站路径，如输入’ba’，chrome浏览器中这会直接补全w ww.baidu.com，这是因为浏览器内核会根据我们的历史输入做智能判断，从而提高我们的网络浏览体验。</p>
<p>##HSTS</p>
<p>按下Enter键后，浏览器一般会检查<a href="https://zh.wikipedia.org/wiki/HTTP%E4%B8%A5%E6%A0%BC%E4%BC%A0%E8%BE%93%E5%AE%89%E5%85%A8" target="_blank" rel="noopener">HSTS</a>列表,HSTS(Http Strict Transport Security)的作用是强制客户端与服务器端使用https协议连接，防止黑客的SSL剥离攻击，但这个策略机制的一个缺点是不能在首次访问某个网站时触发，而通过浏览器预置的HSTS列表就能应对这一缺陷，HSTS列表检测完毕后，浏览器会先在浏览器缓存中查看是否已经有该域名信息，如果没有的话就会调用gethostbyname()方法（不同的操作系统调用的方法不同）去查询系统中是否有缓存信息，如果系统缓存中也没有相关记录，那么该url就会被发送给DNS服务器，为什么要发送给DNS服务器呢？</p>
<p>##DNS</p>
<p>DNS即域名解析系统的作用是将我们输入的url解析为ip地址，为了便于理解与记忆，一般url是用中英文字符表示，但计算机更懂得是机器语言（二进制表示，代表高低电平的0与1）所以每个url都有与之对应的ip地址，一个url可能对应多个ip地址，这又涉及到DNS负载均衡等问题。<br>以下是两个ip地址实例：</p>
<ul>
<li>192.168.55.60（本机在本地局域网的ip地址）</li>
<li>111.13.101.208（本机ping <a href="https://www.baidu.com得到的ip地址）" target="_blank" rel="noopener">https://www.baidu.com得到的ip地址）</a><br>可以发现这两个ip地址并不是二进制表示的，很显然用二进制表示的话会很长，比如上面百度ip地址的二进制表示是1101111000011010110010111010000，非常不方便我们输入与记忆，尽管最终电脑还是得转换为二进制去理解它们。<br>在发送给DNS服务器之前，我们需要知道DNS服务器或默认网关的IP地址，这些工作由ARP（域名解析协议）配合网关，MAC等完成。在得到DNS服务器地址后，通常使用UDP协议发送请求包给DNS服务器进行递归查询，DNS服务器分为根域名服务器，顶级域名服务器（.com/.cn/.org等），及本地域名服务器，查询的过程由根域名一直递归到本地域名服务器，比如百度域名的解析过程是：</li>
</ul>
<p>step1: .com<br>step2: baidu.com.<br>step3: w w w.baidu.com.<br>具体过程可以参考<a href="https://www.zhihu.com/question/23042131" target="_blank" rel="noopener">DNS解析过程详解</a></p>
<p>##建立TCP连接</p>
<p>当DNS服务器返回请求URL对应的IP地址后，这时候就轮到socket（一种由操作系统提供的网络上进程间的通信机制）出场了，作为对TCP/IP协议的封装，socket会发出一个TCP协议的数据流，数据流接着在传输层被加入目标端口继而封装成TCP segment，然后该报文被发送至网络层,网络层会在其中加入本机与目标服务器的ip地址，这时候就变成TCP packet进入链路层，链路层中会为其加入frame头部，里面包含里本机的MAC地址以及网关的MAC地址，最后这个TCP封包就会经由无线或有线网络发送到目标服务器，其中涉及到的网络寻址与路由分发等不在此详表，在浏览器与目标服务器的TCP连接建立后，浏览器就会通过它来发送http请求。<br>在建立TCP连接的过程中客户端与服务器端会发生‘三次握手’，过程如下：</p>
<p><em>三次握手</em><br><img src="http://oupe487b3.bkt.clouddn.com/tcpopen3way.png" alt="三次握手"><br>首先由客户端发送SYN=1标志位与seq=x（x为随机数字，作为该报文的检验数据）的报文到服务器端，此时客户端进入SYN-SENT的状态，服务器端接受到后将返回标志位SYN=1与标志位ACK=1的的报文，并附上确认报文ack=x+1与该报文的seq=y（y同为随机数字，作为该报文的检验数据），此时服务器端的状态是SYN-RECEIVED，当客户端收到该报文时会返回标志位ACK=1与ack=y+1用来表示已正确收到这报文，此时客户端的状态为ESTABLIDHED，当服务器端也接受到时状态也变为ESTABLISHED.<br>TCP三次握手目的是为了防止已失效的连接请求报文段突然又传输到服务端，因而产生错误，本质上这是在不可靠信道上进行可靠传输的最少的通信次数。就像我们打电话，甲说：你好，听到了吗？乙回：我听到了，你听到了吗？甲回：我也听到了。需要经过至少三次的会话才可以确保双方都知道目前通信是可靠的。</p>
<p>##HTTP请求</p>
<p>TCP连接建立后，就可以发送http请求了，http请求由四个部分组成：</p>
<ul>
<li>请求行(request line)，用来说明请求类型（get/post等），要访问的资源URI路径，http版本号等。</li>
<li>请求头部(request header)，缓冲相关控制，客户端代理信息等。</li>
<li>空行(empty line),起标志作用的空行。</li>
<li>请求数据(request data)，客户端发给服务端的请求数据，这部分数据并不是每个请求必须的。</li>
</ul>
<p>HTTP作为应用层的协议，具体作用就是传输文本、图像以及在浏览器与服务器间传输的其他类型文件（比如css、js文件等），浏览器成功发送http请求并得到服务器端的响应，成功接收各种请求资源时，就由浏览器开始渲染工作，但值得注意的时，在现代浏览器中，这个过程不是单线程的，浏览器可以边接收服务器端的资源，边解析与渲染html文件。</p>
<p>##关键渲染路径-Critial Rendering Path</p>
<p>从获取HTML文件直到浏览器以像素点的方式在屏幕中绘制出页面的内容确实经历了很多步骤，这些步骤我们称之为关键渲染路径。优化前端页面的加载与渲染，都可以从关键路径渲染中入手。以下是CRP过程中主要的6个步骤：</p>
<ul>
<li>构建文档对象模型（DOM tree）</li>
<li>构建css对象模型（CSSOM)</li>
<li>完成1阶段后的时间节点叫Domcontentloaded,许多js框架都会在此刻运行js，比如jq，所以这阶段也可认为是运行js阶段。但这不是绝对的，比如某个script标签在head标签里，那么解析器会解析该script标签，这个会阻塞dom与cssom构建，也就意味着Domcontentloaded的时间被大幅增加，大多数时候我们的script标签放在body后面，这样就不会阻塞浏览器的对dom tree与cssom的构建，可以使界面更早的出现。</li>
<li>构建render tree</li>
<li>layout</li>
<li>paint<br>示例图：<br><img src="http://oupe487b3.bkt.clouddn.com/3818607849-58c93559cd9fc_articlex.png" alt="CRP"></li>
</ul>
<p>可以利用Chrome开发者工具下的Timeline去观察整个关键路径渲染的过程，这个具体的timeline分析下次写篇博客中详表。</p>
</div></article></div></main><footer><div class="paginator"><a href="/2018/01/06/js中的匿名函数/" class="prev">PREV</a><a href="/2017/12/11/小程序简易教程-速览/" class="next">NEXT</a></div><div class="copyright"><p>© 2017 - 2018 <a href="http://yoursite.com">hammer</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>